rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check if user is the owner of the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Check if content is appropriate (basic validation)
    function isValidContent(text) {
      return text != null && text.size() > 0 && text.size() <= 10000;
    }
    
    // ========================================
    // USERS COLLECTION
    // ========================================
    
    match /users/{userId} {
      // Anyone can read user profiles
      allow read: if true;
      
      // Users can create their own profile
      allow create: if isSignedIn() && isOwner(userId);
      
      // Users can update their own profile
      allow update: if isSignedIn() && isOwner(userId);
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // ========================================
    // FOLLOWS COLLECTION (NEW - FIXED!)
    // ========================================
    
    match /follows/{followId} {
      // Anyone can read follows
      allow read: if true;
      
      // Authenticated users can create a follow relationship
      // Must be following as themselves (followerId matches auth.uid)
      allow create: if isSignedIn() && 
                       request.resource.data.followerId == request.auth.uid &&
                       request.resource.data.followingId != request.auth.uid; // Can't follow yourself
      
      // Users can delete their own follows (unfollow)
      allow delete: if isSignedIn() && 
                       resource.data.followerId == request.auth.uid;
      
      // No updates allowed (delete and recreate instead)
      allow update: if false;
    }
    
    // ========================================
    // CONVERSATIONS COLLECTION
    // ========================================
    
    match /conversations/{conversationId} {
      // Only participants can read the conversation
      allow read: if isSignedIn() && 
                     request.auth.uid in resource.data.participantIds;
      
      // Authenticated users can create conversations
      allow create: if isSignedIn() && 
                       request.auth.uid in request.resource.data.participantIds;
      
      // Participants can update conversation (e.g., mark as read)
      allow update: if isSignedIn() && 
                       request.auth.uid in resource.data.participantIds;
      
      // Participants can delete conversations
      allow delete: if isSignedIn() && 
                       request.auth.uid in resource.data.participantIds;
      
      // ========================================
      // MESSAGES SUBCOLLECTION
      // ========================================
      
      match /messages/{messageId} {
        // Participants can read messages
        allow read: if isSignedIn() && 
                       request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
        
        // Participants can create messages
        allow create: if isSignedIn() && 
                         request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds &&
                         request.resource.data.senderId == request.auth.uid;
        
        // No updates or deletes for messages
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // ========================================
    // PRAYER REQUESTS COLLECTION
    // ========================================
    
    match /prayerRequests/{requestId} {
      // Anyone can read prayer requests
      allow read: if true;
      
      // Authenticated users can create prayer requests
      allow create: if isSignedIn() && 
                       request.resource.data.userId == request.auth.uid &&
                       isValidContent(request.resource.data.description);
      
      // Users can update their own prayer requests
      allow update: if isSignedIn() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      // Users can delete their own prayer requests
      allow delete: if isSignedIn() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      // ========================================
      // PRAYER COMMENTS SUBCOLLECTION
      // ========================================
      
      match /comments/{commentId} {
        // Anyone can read comments
        allow read: if true;
        
        // Authenticated users can create comments
        allow create: if isSignedIn() && 
                         request.resource.data.userId == request.auth.uid;
        
        // Users can update/delete their own comments
        allow update, delete: if isSignedIn() && 
                                 (resource.data.userId == request.auth.uid || isAdmin());
      }
      
      // ========================================
      // PRAYER REACTIONS SUBCOLLECTION
      // ========================================
      
      match /reactions/{reactionId} {
        // Anyone can read reactions
        allow read: if true;
        
        // Authenticated users can create reactions
        allow create: if isSignedIn() && 
                         request.resource.data.userId == request.auth.uid;
        
        // Users can delete their own reactions
        allow delete: if isSignedIn() && 
                         resource.data.userId == request.auth.uid;
        
        // No updates (delete and recreate instead)
        allow update: if false;
      }
    }
    
    // ========================================
    // TESTIMONIES COLLECTION
    // ========================================
    
    match /testimonies/{testimonyId} {
      // Anyone can read testimonies
      allow read: if true;
      
      // Authenticated users can create testimonies
      allow create: if isSignedIn() && 
                       request.resource.data.userId == request.auth.uid &&
                       isValidContent(request.resource.data.content);
      
      // Users can update their own testimonies
      allow update: if isSignedIn() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      // Users can delete their own testimonies
      allow delete: if isSignedIn() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      // ========================================
      // TESTIMONY REACTIONS SUBCOLLECTION
      // ========================================
      
      match /reactions/{reactionId} {
        // Anyone can read reactions
        allow read: if true;
        
        // Authenticated users can create reactions
        allow create: if isSignedIn() && 
                         request.resource.data.userId == request.auth.uid;
        
        // Users can delete their own reactions
        allow delete: if isSignedIn() && 
                         resource.data.userId == request.auth.uid;
        
        // No updates
        allow update: if false;
      }
      
      // ========================================
      // TESTIMONY COMMENTS SUBCOLLECTION
      // ========================================
      
      match /comments/{commentId} {
        // Anyone can read comments
        allow read: if true;
        
        // Authenticated users can create comments
        allow create: if isSignedIn() && 
                         request.resource.data.userId == request.auth.uid;
        
        // Users can update/delete their own comments
        allow update, delete: if isSignedIn() && 
                                 (resource.data.userId == request.auth.uid || isAdmin());
      }
    }
    
    // ========================================
    // OPENTABLE POSTS COLLECTION
    // ========================================
    
    match /openTablePosts/{postId} {
      // Anyone can read posts
      allow read: if true;
      
      // Authenticated users can create posts
      allow create: if isSignedIn() && 
                       request.resource.data.userId == request.auth.uid &&
                       isValidContent(request.resource.data.content);
      
      // Users can update their own posts
      allow update: if isSignedIn() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      // Users can delete their own posts
      allow delete: if isSignedIn() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      // ========================================
      // POST REACTIONS SUBCOLLECTION
      // ========================================
      
      match /reactions/{reactionId} {
        // Anyone can read reactions
        allow read: if true;
        
        // Authenticated users can create reactions
        allow create: if isSignedIn() && 
                         request.resource.data.userId == request.auth.uid;
        
        // Users can delete their own reactions
        allow delete: if isSignedIn() && 
                         resource.data.userId == request.auth.uid;
        
        // No updates
        allow update: if false;
      }
      
      // ========================================
      // POST COMMENTS SUBCOLLECTION
      // ========================================
      
      match /comments/{commentId} {
        // Anyone can read comments
        allow read: if true;
        
        // Authenticated users can create comments
        allow create: if isSignedIn() && 
                         request.resource.data.userId == request.auth.uid;
        
        // Users can update/delete their own comments
        allow update, delete: if isSignedIn() && 
                                 (resource.data.userId == request.auth.uid || isAdmin());
      }
    }
    
    // ========================================
    // NOTIFICATIONS COLLECTION
    // ========================================
    
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isSignedIn() && 
                     resource.data.userId == request.auth.uid;
      
      // System/Cloud Functions can create notifications
      // Users can also create notifications (for saved search matches, etc.)
      allow create: if isSignedIn();
      
      // Users can update their own notifications (e.g., mark as read)
      allow update: if isSignedIn() && 
                       resource.data.userId == request.auth.uid;
      
      // Users can delete their own notifications
      allow delete: if isSignedIn() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ========================================
    // SAVED SEARCHES COLLECTION
    // ========================================
    
    match /savedSearches/{searchId} {
      // Users can only read their own saved searches
      allow read: if isSignedIn() && 
                     resource.data.userId == request.auth.uid;
      
      // Users can create their own saved searches
      allow create: if isSignedIn() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Users can update their own saved searches
      allow update: if isSignedIn() && 
                       resource.data.userId == request.auth.uid;
      
      // Users can delete their own saved searches
      allow delete: if isSignedIn() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ========================================
    // COMMUNITIES COLLECTION (FUTURE)
    // ========================================
    
    match /communities/{communityId} {
      // Anyone can read public communities
      allow read: if true;
      
      // Authenticated users can create communities
      allow create: if isSignedIn() && 
                       request.resource.data.creatorId == request.auth.uid;
      
      // Community admins can update
      allow update: if isSignedIn() && 
                       (resource.data.creatorId == request.auth.uid || 
                        request.auth.uid in resource.data.adminIds);
      
      // Only creator can delete
      allow delete: if isSignedIn() && 
                       resource.data.creatorId == request.auth.uid;
    }
    
    // ========================================
    // REPORTS COLLECTION (MODERATION)
    // ========================================
    
    match /reports/{reportId} {
      // Only admins can read reports
      allow read: if isAdmin();
      
      // Authenticated users can create reports
      allow create: if isSignedIn() && 
                       request.resource.data.reporterId == request.auth.uid;
      
      // Only admins can update/delete reports
      allow update, delete: if isAdmin();
    }
    
    // ========================================
    // ANALYTICS COLLECTION (OPTIONAL)
    // ========================================
    
    match /analytics/{docId} {
      // Only system can read/write analytics
      allow read, write: if false;
    }
    
    // ========================================
    // DEFAULT DENY
    // ========================================
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
