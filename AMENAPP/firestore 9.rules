rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isParticipant(participantIds) {
      return request.auth.uid in participantIds;
    }
    
    function isValidParticipant(conversationData) {
      return request.auth.uid in conversationData.participantIds;
    }
    
    function isValidTextLength(text, maxLength) {
      return text.size() <= maxLength;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isSignedIn();
      
      // Users can create their own profile
      allow create: if isSignedIn() && 
                       isOwner(userId) &&
                       request.resource.data.email == request.auth.token.email;
      
      // Users can update their own profile
      // Prevent changing follower/following/post counts manually
      allow update: if isSignedIn() && 
                       isOwner(userId) &&
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['followersCount', 'followingCount', 'postsCount']) ||
                        request.resource.data.email == resource.data.email);
      
      // Users can delete their own profile
      allow delete: if isSignedIn() && isOwner(userId);
      
      // ========== FOLLOWING SUBCOLLECTION ==========
      match /following/{followedUserId} {
        // Can read your own following list or anyone else's (public)
        allow read: if isSignedIn();
        
        // Can create a follow if you're the owner
        allow create: if isSignedIn() && isOwner(userId);
        
        // Can delete your own follows
        allow delete: if isSignedIn() && isOwner(userId);
      }
      
      // ========== FOLLOWERS SUBCOLLECTION ==========
      match /followers/{followerId} {
        // Can read your own followers list or anyone else's (public)
        allow read: if isSignedIn();
        
        // System or the follower themselves can create
        allow create: if isSignedIn();
        
        // Can delete your own follower entry or if you're the owner
        allow delete: if isSignedIn() && (isOwner(followerId) || isOwner(userId));
      }
    }
    
    // ============================================
    // FOLLOWS COLLECTION (Top-level)
    // ============================================
    
    match /follows/{followId} {
      // Anyone can read follows (for social features)
      allow read: if isSignedIn();
      
      // Can create a follow if you're the follower
      allow create: if isSignedIn() && 
                       request.resource.data.followerId == request.auth.uid;
      
      // Can delete your own follows
      allow delete: if isSignedIn() && 
                       resource.data.followerId == request.auth.uid;
      
      // Can't update follows
      allow update: if false;
    }
    
    // ============================================
    // POSTS COLLECTION (All post types)
    // ============================================
    
    match /posts/{postId} {
      // Anyone can read posts
      allow read: if isSignedIn();
      
      // Can create your own posts with valid data
      allow create: if isSignedIn() && 
                       request.resource.data.authorId == request.auth.uid &&
                       isValidTextLength(request.resource.data.content, 10000);
      
      // Can update/delete your own posts
      allow update, delete: if isSignedIn() && 
                               resource.data.authorId == request.auth.uid;
      
      // ========== COMMENTS SUBCOLLECTION ==========
      match /comments/{commentId} {
        allow read: if isSignedIn();
        
        allow create: if isSignedIn() && 
                         request.resource.data.authorId == request.auth.uid &&
                         isValidTextLength(request.resource.data.content, 2000);
        
        allow update: if isSignedIn() && 
                         resource.data.authorId == request.auth.uid;
        
        // Post author or comment author can delete
        allow delete: if isSignedIn() && 
                         (resource.data.authorId == request.auth.uid ||
                          get(/databases/$(database)/documents/posts/$(postId)).data.authorId == request.auth.uid);
      }
      
      // ========== LIKES SUBCOLLECTION ==========
      match /likes/{userId} {
        allow read: if isSignedIn();
        allow create, delete: if isSignedIn() && isOwner(userId);
      }
      
      // ========== REPOSTS SUBCOLLECTION ==========
      match /reposts/{userId} {
        allow read: if isSignedIn();
        allow create, delete: if isSignedIn() && isOwner(userId);
      }
    }
    
    // ============================================
    // CONVERSATIONS COLLECTION (FIXED!)
    // ============================================
    
    match /conversations/{conversationId} {
      // Read: if you're a participant in THIS conversation
      allow read: if isSignedIn() && 
                     (request.auth.uid in resource.data.participantIds);
      
      // Create: if you're in the participantIds list you're trying to create
      // This is the fix for your issue!
      allow create: if isSignedIn() && 
                       request.auth.uid in request.resource.data.participantIds;
      
      // Update: if you're a participant
      allow update: if isSignedIn() && 
                       request.auth.uid in resource.data.participantIds;
      
      // Delete: if you're a participant (soft delete with deletedBy field)
      allow delete: if isSignedIn() && 
                       request.auth.uid in resource.data.participantIds;
      
      // ========== MESSAGES SUBCOLLECTION ==========
      match /messages/{messageId} {
        // Read: if you're in the conversation
        allow read: if isSignedIn() &&
                       request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
        
        // Create: if you're in conversation AND you're the sender
        allow create: if isSignedIn() &&
                         request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds &&
                         request.resource.data.senderId == request.auth.uid &&
                         isValidTextLength(request.resource.data.text, 10000);
        
        // Update: only your own messages
        allow update: if isSignedIn() &&
                         resource.data.senderId == request.auth.uid;
        
        // Delete: only your own messages
        allow delete: if isSignedIn() &&
                         resource.data.senderId == request.auth.uid;
      }
    }
    
    // ============================================
    // MESSAGE REQUESTS
    // ============================================
    
    match /messageRequests/{requestId} {
      // Read: if it's to you or from you
      allow read: if isSignedIn() && 
                     (request.auth.uid == resource.data.fromUserId ||
                      request.auth.uid == resource.data.toUserId);
      
      // Create: if you're the sender
      allow create: if isSignedIn() &&
                       request.auth.uid == request.resource.data.fromUserId;
      
      // Update: if it's to you (accepting/declining)
      allow update: if isSignedIn() &&
                       request.auth.uid == resource.data.toUserId;
      
      // Delete: if it's to you or from you
      allow delete: if isSignedIn() &&
                       (request.auth.uid == resource.data.toUserId ||
                        request.auth.uid == resource.data.fromUserId);
    }
    
    // ============================================
    // NOTIFICATIONS
    // ============================================
    
    match /notifications/{userId}/items/{notificationId} {
      // Only you can read your notifications
      allow read: if isSignedIn() && isOwner(userId);
      
      // System creates notifications (allow for now)
      allow create: if isSignedIn();
      
      // Only you can mark as read/delete
      allow update, delete: if isSignedIn() && isOwner(userId);
    }
    
    // ============================================
    // SAVED POSTS
    // ============================================
    
    match /savedPosts/{saveId} {
      // Read: only your own saved posts
      allow read: if isSignedIn() && 
                     resource.data.userId == request.auth.uid;
      
      // Create: only for yourself
      allow create: if isSignedIn() &&
                       request.resource.data.userId == request.auth.uid;
      
      // Delete: only your own saves
      allow delete: if isSignedIn() &&
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // BLOCKS
    // ============================================
    
    match /blocks/{blockId} {
      // Anyone can read (to check if blocked)
      allow read: if isSignedIn();
      
      // Can block users
      allow create: if isSignedIn() &&
                       request.resource.data.blockerId == request.auth.uid;
      
      // Can unblock
      allow delete: if isSignedIn() &&
                       resource.data.blockerId == request.auth.uid;
    }
    
    // ============================================
    // REPORTS
    // ============================================
    
    match /reports/{reportId} {
      // Can read your own reports
      allow read: if isSignedIn() && 
                     resource.data.reporterId == request.auth.uid;
      
      // Anyone can create a report
      allow create: if isSignedIn() &&
                       request.resource.data.reporterId == request.auth.uid &&
                       isValidTextLength(request.resource.data.reason, 1000);
      
      // Can't update or delete reports
      allow update, delete: if false;
    }
    
    // ============================================
    // PRAYERS
    // ============================================
    
    match /prayers/{prayerId} {
      allow read: if isSignedIn();
      
      allow create: if isSignedIn() && 
                       request.resource.data.authorId == request.auth.uid &&
                       isValidTextLength(request.resource.data.content, 5000);
      
      allow update, delete: if isSignedIn() && 
                               resource.data.authorId == request.auth.uid;
      
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && 
                         request.resource.data.authorId == request.auth.uid;
        allow update: if isSignedIn() && 
                         resource.data.authorId == request.auth.uid;
        allow delete: if isSignedIn() && 
                         (resource.data.authorId == request.auth.uid ||
                          get(/databases/$(database)/documents/prayers/$(prayerId)).data.authorId == request.auth.uid);
      }
      
      match /support/{userId} {
        allow read: if isSignedIn();
        allow create, delete: if isSignedIn() && isOwner(userId);
      }
    }
    
    // ============================================
    // TESTIMONIES
    // ============================================
    
    match /testimonies/{testimonyId} {
      allow read: if isSignedIn();
      
      allow create: if isSignedIn() && 
                       request.resource.data.authorId == request.auth.uid &&
                       isValidTextLength(request.resource.data.content, 10000);
      
      allow update, delete: if isSignedIn() && 
                               resource.data.authorId == request.auth.uid;
      
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && 
                         request.resource.data.authorId == request.auth.uid;
        allow update: if isSignedIn() && 
                         resource.data.authorId == request.auth.uid;
        allow delete: if isSignedIn() && 
                         (resource.data.authorId == request.auth.uid ||
                          get(/databases/$(database)/documents/testimonies/$(testimonyId)).data.authorId == request.auth.uid);
      }
      
      match /likes/{userId} {
        allow read: if isSignedIn();
        allow create, delete: if isSignedIn() && isOwner(userId);
      }
    }
    
    // ============================================
    // COMMUNITIES (If you have them)
    // ============================================
    
    match /communities/{communityId} {
      allow read: if isSignedIn();
      
      allow create: if isSignedIn() &&
                       request.resource.data.creatorId == request.auth.uid;
      
      allow update: if isSignedIn() &&
                       (resource.data.creatorId == request.auth.uid ||
                        request.auth.uid in resource.data.adminIds);
      
      allow delete: if isSignedIn() &&
                       resource.data.creatorId == request.auth.uid;
      
      match /members/{userId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow delete: if isSignedIn() && 
                         (isOwner(userId) ||
                          get(/databases/$(database)/documents/communities/$(communityId)).data.creatorId == request.auth.uid);
      }
    }
    
    // ============================================
    // ANALYTICS (Write-only)
    // ============================================
    
    match /analytics/{document=**} {
      allow read: if false;
      allow write: if isSignedIn();
    }
    
    // ============================================
    // ADMIN (Restricted)
    // ============================================
    
    match /admin/{document=**} {
      allow read, write: if false;
    }
  }
}
