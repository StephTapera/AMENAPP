// ===== CONVERSATIONS COLLECTION =====
match /conversations/{conversationId} {
  function isParticipant() {
    return request.auth.uid in resource.data.participantIds;
  }
  
  function willBeParticipant() {
    return request.auth.uid in request.resource.data.participantIds;
  }
  
  // Allow read if user is a participant
  allow read: if isSignedIn() && isParticipant();
  
  // Allow create if user is in the participant list
  allow create: if isSignedIn() && willBeParticipant();
  
  // Allow update if user is a participant (for marking as read, archiving, etc.)
  allow update: if isSignedIn() && isParticipant();
  
  // Allow delete if user is a participant
  allow delete: if isSignedIn() && isParticipant();
  
  // Messages subcollection
  match /messages/{messageId} {
    // Allow read only if user is a participant in the parent conversation
    allow read: if isSignedIn() && 
                   request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
    
    // Allow create only if user is a participant
    allow create: if isSignedIn() && 
                     request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
    
    // Allow update/delete only if user is the sender
    allow update, delete: if isSignedIn() && 
                             request.auth.uid == resource.data.senderId;
  }
  
  // Typing indicators
  match /typing/{userId} {
    allow read: if isSignedIn();
    allow write: if isSignedIn() && isOwner(userId);
  }
}

// ===== MESSAGE REQUESTS =====
match /messageRequests/{requestId} {
  // Allow read if user is the recipient
  allow read: if isSignedIn() && 
                 request.auth.uid == resource.data.toUserId;
  
  // Allow create for any authenticated user
  allow create: if isSignedIn();
  
  // Allow update if user is the recipient (for marking as read)
  allow update: if isSignedIn() && 
                   request.auth.uid == resource.data.toUserId;
  
  // Allow delete if user is sender or recipient
  allow delete: if isSignedIn() && 
                   (request.auth.uid == resource.data.fromUserId || 
                    request.auth.uid == resource.data.toUserId);
}

// ===== BLOCKED USERS =====
match /blockedUsers/{userId}/blocked/{blockedUserId} {
  // Only user can read/write their own blocked list
  allow read, write: if isSignedIn() && isOwner(userId);
}
