rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isValidString(text, minLen, maxLen) {
      return text is string 
        && text.size() >= minLen 
        && text.size() <= maxLen;
    }
    
    function isValidEmail(email) {
      return email is string && email.matches('.*@.*\\..*');
    }
    
    // Users Collection
    match /users/{userId} {
      // Anyone can read public user profiles
      allow read: if isSignedIn();
      
      // Users can only create their own profile during signup
      allow create: if isOwner(userId) 
        && request.resource.data.email == request.auth.token.email
        && isValidString(request.resource.data.displayName, 1, 100)
        && isValidString(request.resource.data.username, 1, 30)
        && request.resource.data.followersCount == 0
        && request.resource.data.followingCount == 0
        && request.resource.data.postsCount == 0;
      
      // Users can only update their own profile
      allow update: if isOwner(userId)
        && request.resource.data.email == resource.data.email // Can't change email
        && request.resource.data.createdAt == resource.data.createdAt // Can't change creation date
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['followersCount', 'followingCount', 'postsCount'])); // Can't manually change counts
      
      // Users can only delete their own profile
      allow delete: if isOwner(userId);
      
      // User's saved posts subcollection
      match /savedPosts/{postId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // Posts Collection
    match /posts/{postId} {
      // Anyone authenticated can read posts
      allow read: if isSignedIn();
      
      // Only authenticated users can create posts
      allow create: if isSignedIn()
        && request.resource.data.authorId == request.auth.uid
        && isValidString(request.resource.data.content, 1, 500)
        && request.resource.data.category in ['openTable', 'testimonies', 'prayer']
        && request.resource.data.visibility in ['everyone', 'followers', 'private']
        && request.resource.data.likesCount == 0
        && request.resource.data.commentsCount == 0
        && request.resource.data.repostsCount == 0
        && request.resource.data.savesCount == 0;
      
      // Only post author can update their own posts
      allow update: if isOwner(resource.data.authorId)
        && request.resource.data.authorId == resource.data.authorId // Can't change author
        && request.resource.data.createdAt == resource.data.createdAt // Can't change creation date
        && (!request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['likesCount', 'commentsCount', 'repostsCount', 'savesCount'])); // Counts managed by cloud functions
      
      // Only post author can delete their posts
      allow delete: if isOwner(resource.data.authorId);
      
      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isSignedIn();
        
        allow create: if isSignedIn()
          && request.resource.data.authorId == request.auth.uid
          && isValidString(request.resource.data.content, 1, 500)
          && request.resource.data.likesCount == 0;
        
        allow update: if isOwner(resource.data.authorId)
          && request.resource.data.authorId == resource.data.authorId
          && request.resource.data.createdAt == resource.data.createdAt
          && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['likesCount']);
        
        allow delete: if isOwner(resource.data.authorId);
      }
      
      // Likes subcollection for posts
      match /likes/{userId} {
        allow read: if isSignedIn();
        allow write: if isOwner(userId);
      }
    }
    
    // Testimonies Collection (similar to posts)
    match /testimonies/{testimonyId} {
      allow read: if isSignedIn();
      
      allow create: if isSignedIn()
        && request.resource.data.authorId == request.auth.uid
        && isValidString(request.resource.data.content, 1, 1000)
        && request.resource.data.likesCount == 0
        && request.resource.data.commentsCount == 0;
      
      allow update: if isOwner(resource.data.authorId)
        && request.resource.data.authorId == resource.data.authorId
        && request.resource.data.createdAt == resource.data.createdAt
        && !request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['likesCount', 'commentsCount']);
      
      allow delete: if isOwner(resource.data.authorId);
    }
    
    // Prayers Collection
    match /prayers/{prayerId} {
      allow read: if isSignedIn();
      
      allow create: if isSignedIn()
        && request.resource.data.authorId == request.auth.uid
        && isValidString(request.resource.data.content, 1, 500)
        && request.resource.data.prayerType in ['Prayer Request', 'Praise Report', 'Answered Prayer']
        && request.resource.data.prayersCount == 0
        && request.resource.data.commentsCount == 0;
      
      allow update: if isOwner(resource.data.authorId)
        && request.resource.data.authorId == resource.data.authorId
        && request.resource.data.createdAt == resource.data.createdAt
        && !request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['prayersCount', 'commentsCount']);
      
      allow delete: if isOwner(resource.data.authorId);
      
      // Prayer responses (like "Praying for you")
      match /prayingUsers/{userId} {
        allow read: if isSignedIn();
        allow write: if isOwner(userId);
      }
    }
    
    // Comments Collection (global comments)
    match /comments/{commentId} {
      allow read: if isSignedIn();
      
      allow create: if isSignedIn()
        && request.resource.data.authorId == request.auth.uid
        && isValidString(request.resource.data.content, 1, 500)
        && request.resource.data.likesCount == 0;
      
      allow update: if isOwner(resource.data.authorId)
        && request.resource.data.authorId == resource.data.authorId
        && request.resource.data.createdAt == resource.data.createdAt
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['likesCount']);
      
      allow delete: if isOwner(resource.data.authorId);
    }
    
    // Messages Collection (Direct Messages)
    match /messages/{messageId} {
      // Users can read messages they're part of
      allow read: if isSignedIn() 
        && (request.auth.uid in resource.data.participantIds);
      
      // Users can create messages in conversations they're part of
      allow create: if isSignedIn()
        && request.auth.uid in request.resource.data.participantIds
        && request.resource.data.senderId == request.auth.uid
        && isValidString(request.resource.data.content, 1, 1000);
      
      // Only sender can update their own message (for editing)
      allow update: if isOwner(resource.data.senderId)
        && request.resource.data.senderId == resource.data.senderId
        && request.resource.data.createdAt == resource.data.createdAt;
      
      // Only sender can delete their message
      allow delete: if isOwner(resource.data.senderId);
    }
    
    // Notifications Collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isSignedIn() 
        && request.auth.uid == resource.data.recipientId;
      
      // System/authorized users can create notifications
      allow create: if isSignedIn();
      
      // Users can update their own notifications (mark as read)
      allow update: if isSignedIn() 
        && request.auth.uid == resource.data.recipientId
        && request.resource.data.recipientId == resource.data.recipientId
        && request.resource.data.createdAt == resource.data.createdAt;
      
      // Users can delete their own notifications
      allow delete: if isSignedIn() 
        && request.auth.uid == resource.data.recipientId;
    }
    
    // Communities/Groups Collection
    match /communities/{communityId} {
      allow read: if isSignedIn();
      
      allow create: if isSignedIn()
        && request.resource.data.creatorId == request.auth.uid
        && isValidString(request.resource.data.name, 1, 100)
        && request.resource.data.membersCount == 1
        && request.resource.data.postsCount == 0;
      
      allow update: if isSignedIn()
        && (request.auth.uid == resource.data.creatorId 
            || request.auth.uid in resource.data.adminIds);
      
      allow delete: if isSignedIn()
        && request.auth.uid == resource.data.creatorId;
      
      // Community members subcollection
      match /members/{userId} {
        allow read: if isSignedIn();
        allow write: if isOwner(userId) 
          || request.auth.uid == get(/databases/$(database)/documents/communities/$(communityId)).data.creatorId;
      }
    }
    
    // Follows Collection (who follows who)
    match /follows/{followId} {
      allow read: if isSignedIn();
      
      // Users can create follow relationships
      allow create: if isSignedIn()
        && request.resource.data.followerId == request.auth.uid;
      
      // Users can delete their own follows
      allow delete: if isSignedIn()
        && resource.data.followerId == request.auth.uid;
    }
    
    // Reposts Collection
    match /reposts/{repostId} {
      allow read: if isSignedIn();
      
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Saved Posts Collection
    match /savedPosts/{savedPostId} {
      allow read: if isOwner(resource.data.userId);
      
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
