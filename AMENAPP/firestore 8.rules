rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ===== USERS COLLECTION =====
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuthenticated();
      
      // Only the user can update their own profile
      allow write: if isOwner(userId);
      
      // Blocked Users subcollection
      match /blockedUsers/{blockedUserId} {
        // Only the user can read their own blocked list
        allow read: if isOwner(userId);
        
        // Only the user can block/unblock
        allow write: if isOwner(userId);
      }
      
      // Following subcollection
      match /following/{followingId} {
        // Anyone can read who a user follows
        allow read: if isAuthenticated();
        
        // Only the user can manage their following list
        allow write: if isOwner(userId);
      }
      
      // Followers subcollection
      match /followers/{followerId} {
        // Anyone can read a user's followers
        allow read: if isAuthenticated();
        
        // The follower can add/remove themselves
        allow write: if isAuthenticated() && request.auth.uid == followerId;
      }
    }
    
    // ===== POSTS COLLECTION =====
    match /posts/{postId} {
      // Anyone authenticated can read posts
      allow read: if isAuthenticated();
      
      // Only the author can create/update/delete their posts
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.authorId;
      allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.authorId;
    }
    
    // ===== CONVERSATIONS COLLECTION =====
    match /conversations/{conversationId} {
      // Helper function to check if user is a participant (check both field names)
      function isParticipant() {
        return request.auth.uid in resource.data.get('participantIds', []) ||
               request.auth.uid in resource.data.get('participants', []);
      }
      
      function isCreatingAsParticipant() {
        return request.auth.uid in request.resource.data.get('participantIds', []) ||
               request.auth.uid in request.resource.data.get('participants', []);
      }
      
      // Only participants can read the conversation
      allow read: if isAuthenticated() && isParticipant();
      
      // Only participants can update (e.g., mark as read)
      allow update: if isAuthenticated() && isParticipant();
      
      // Anyone authenticated can create if they're a participant
      allow create: if isAuthenticated() && isCreatingAsParticipant();
      
      // Only participants can delete
      allow delete: if isAuthenticated() && isParticipant();
    }
    
    // ===== MESSAGES COLLECTION (Top-level, not subcollection) =====
    match /messages/{messageId} {
      // Helper to check if user is in the message's conversation
      function isInConversation() {
        // Try to get the conversation and check if user is a participant
        let conversationId = resource.data.conversationId;
        let conversation = get(/databases/$(database)/documents/conversations/$(conversationId)).data;
        return request.auth.uid in conversation.get('participantIds', []) ||
               request.auth.uid in conversation.get('participants', []);
      }
      
      // Anyone in the conversation can read messages
      allow read: if isAuthenticated() && isInConversation();
      
      // Anyone in the conversation can create messages
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.senderId;
      
      // Only sender can update/delete their own messages
      allow update, delete: if isAuthenticated() && 
        request.auth.uid == resource.data.senderId;
    }
    
    // ===== COMMENTS COLLECTION =====
    match /comments/{commentId} {
      // Anyone authenticated can read comments
      allow read: if isAuthenticated();
      
      // Only the author can create/update/delete their comments
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.authorId;
      allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.authorId;
    }
    
    // ===== NOTIFICATIONS COLLECTION =====
    match /notifications/{notificationId} {
      // Only the recipient can read their notifications
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      
      // Anyone can create notifications (system generated)
      allow create: if isAuthenticated();
      
      // Only the recipient can update (mark as read)
      allow update: if isAuthenticated() && request.auth.uid == resource.data.userId;
      
      // Only the recipient can delete
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }
    
    // ===== SAVED POSTS COLLECTION =====
    match /saved_posts/{saveId} {
      // Only the user can read their saved posts
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      
      // Only the user can save/unsave posts
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }
    
    // ===== COMMUNITIES COLLECTION =====
    match /communities/{communityId} {
      // Anyone authenticated can read communities
      allow read: if isAuthenticated();
      
      // Only community creator or admins can update
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.creatorId ||
        request.auth.uid in resource.data.adminIds
      );
      
      // Anyone authenticated can create communities
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.creatorId;
      
      // Only creator can delete
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.creatorId;
      
      // Community Members subcollection
      match /members/{memberId} {
        // Anyone can read members
        allow read: if isAuthenticated();
        
        // Admins and the member themselves can manage membership
        allow write: if isAuthenticated() && (
          request.auth.uid == memberId ||
          request.auth.uid in get(/databases/$(database)/documents/communities/$(communityId)).data.adminIds
        );
      }
    }
    
    // ===== REPORTS COLLECTION =====
    match /reports/{reportId} {
      // Only the reporter can read their own reports
      allow read: if isAuthenticated() && request.auth.uid == resource.data.reporterId;
      
      // Anyone authenticated can create reports
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.reporterId;
      
      // Reports cannot be updated or deleted by users
      allow update, delete: if false;
    }
    
    // ===== MESSAGE REQUESTS COLLECTION =====
    match /message_requests/{requestId} {
      // Only recipient can read their requests
      allow read: if isAuthenticated() && request.auth.uid == resource.data.recipientId;
      
      // Only sender can create
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.senderId;
      
      // Only recipient can update (accept/decline)
      allow update: if isAuthenticated() && request.auth.uid == resource.data.recipientId;
      
      // Sender or recipient can delete
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.senderId ||
        request.auth.uid == resource.data.recipientId
      );
    }
    
    // ===== BLOCKS COLLECTION (Global block relationships) =====
    match /blocks/{blockId} {
      // Only the blocker can read their blocks
      allow read: if isAuthenticated() && request.auth.uid == resource.data.blockerId;
      
      // Only the blocker can create
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.blockerId;
      
      // Only the blocker can delete (unblock)
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.blockerId;
    }
    
    // ===== FOLLOWS COLLECTION (Global follow relationships) =====
    match /follows/{followId} {
      // Anyone can read follow relationships
      allow read: if isAuthenticated();
      
      // Only the follower can create (user following someone)
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.followerId;
      
      // Only the follower can delete (unfollow)
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.followerId;
    }
    
    // ===== BLOCKED USERS COLLECTION (Global - top-level) =====
    match /blockedUsers/{blockId} {
      // Anyone can read (to check if they're blocked before messaging)
      allow read: if isAuthenticated();
      
      // Only the blocker can create
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      
      // Only the blocker can delete (unblock)
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }
    
    // ===== MUTED USERS COLLECTION =====
    match /mutedUsers/{muteId} {
      // Anyone can read (to check mute status)
      allow read: if isAuthenticated();
      
      // Only the user can mute someone
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      
      // Only the user can unmute
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }
    
    // ===== ANALYTICS (Optional) =====
    match /analytics/{userId} {
      // Only the user can read/write their analytics
      allow read, write: if isOwner(userId);
    }
    
    // ===== PRAYER REQUESTS =====
    match /prayer_requests/{requestId} {
      // Anyone authenticated can read
      allow read: if isAuthenticated();
      
      // Only author can create/update/delete
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.authorId;
      allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.authorId;
    }
    
    // ===== BIBLE STUDY GROUPS =====
    match /bible_study_groups/{groupId} {
      // Anyone authenticated can read
      allow read: if isAuthenticated();
      
      // Only creator can create/update/delete
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.creatorId;
      allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.creatorId;
    }
  }
}
